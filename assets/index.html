<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
</head>
<body lang="en">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="brand" href="#">tgz-Viewer</a>
          <div class="nav-collapse collapse">
            <ul class="nav" id="breadcrumbs">
              <li class="active"><a href="#" id="home">/</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12" id="list-container">
          <form class="form-inline">
              <input type="text" placeholder="Type somethingâ€¦">
              <button type="submit" class="btn btn-inverse">Filter</button>
          </form>
          <div class="well sidebar-nav">
            <ul id="list" class="nav nav-list"></ul>
          </div>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span12" id="raw-container">
          <iframe id="raw" src="about:blank" width="800" height="10" frameborder="0" scrolling="yes"></iframe>
        </div>
      </div>
    </div>


    <script src="js/jquery-1.7.7.min.js"></script>
    <script src="js/sockjs-0.3.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>

    <script>
      function discardFrameContent() {
        $('#raw')
          .attr('height', 10)
          .attr('src', "about:blank");
      }

      function maximizeFrame () {
        var width = $('#raw-container').width();
        $('#raw')
          .attr('width', width)
          .attr('height', document.height - 160 - 5); // padding-top 100 + empty list 60 + approx 5
      }

      $(window).resize(function() {
        // iframe in use?
        var src = $('#raw').attr('src');
        if(src !== "about:blank") {
          maximizeFrame ();
        }
      });

      var listEntries = [],
          breadcrumbs = [];


      function descriptorSelected(descriptor) {              
          if((descriptor.is_file && !descriptor.is_archive) || descriptor.is_entry) {
              $('#list').empty();
              $('#raw')
                  .attr('src', document.location.origin + "/content?descriptor=" + descriptor.asBase64);
              maximizeFrame ();
          }
          else {
              var list = $('#list');
              $.getJSON("/content", {descriptor:descriptor.asBase64}, function(res) {

                  discardFrameContent();
                  $("#archive").text("");
                  $("#file").text("");
                  list.empty()
                  listEntries = res;
                
                  console.log("Received: ", res);
                  var n = res.length, i, label;
                  for(i=0; i<n; i++) {
                      console.log("appending ", res[i]);
                      label = res[i].path;
                      if(res[i].is_entry) {
                        label = res[i].entry_path;
                      }

                      var elemA  = $("<a href='#'>" + label + "</a>").attr('listIndex', i);
                      elemA.click(listEntryClicked);
                      var elemLi = $("<li class='archive'></li>");
                      elemLi.append(elemA);
                      list.append(elemLi);
                  }
              });
          }
      }

      function breadcrumbClicked() {
          var $entry = $(this),
              listIndex = $entry.attr('listIndex'),
              descriptor = breadcrumbs[listIndex];

          breadcrumbs = breadcrumbs.slice(0, listIndex + 1);
          descriptorSelected(descriptor);
          renderBreadcrumbs();
      }

      function renderBreadcrumbs() {
        var $breadcrumbs = $("#breadcrumbs"),
            i,
            n = breadcrumbs.length;

        // discard any existing bread=
        $breadcrumbs.find(".descriptor").remove();

        //
        for(i=0; i<n; i++) {
          var descriptor = breadcrumbs[i],
              label = (descriptor.is_entry ? descriptor.entry_path : descriptor.path);

          if(i < (n-1)) {
            label = label + "&nbsp;/";
          }

          var $a  = $('<a href="#" class="descriptor">' + label + '</a>'),
              $li = $('<li></li>');

          if(i < (n-1)) {
            $a.click(breadcrumbClicked);
            $a.attr('listIndex', i);
          }
          $li.append($a);
          $breadcrumbs.append($li);
        }

        $breadcrumbs.last().addClass("active");
      }

      function listEntryClicked() {
          var $entry = $(this),
              descriptor = listEntries[$entry.attr('listIndex')];
          descriptorSelected(descriptor);
          breadcrumbs.push(descriptor);
          renderBreadcrumbs();
      }

      function rootContent() {
        $.getJSON("/root-content", function(res) {

          var list = $('#list');
          list.empty()
          discardFrameContent();
          listEntries = res;

          breadcrumbs = [];
          renderBreadcrumbs();
          
          console.log("Received: ", res);
          var n = res.length, i;
          for(i=0; i<n; i++) {
            console.log("appending ", res[i]);
            var elemA  = $("<a href='#'>" + res[i].path + "</a>").attr('listIndex', i);
            elemA.click(listEntryClicked);
            var elemLi = $("<li class='archive'></li>");
            elemLi.append(elemA);
            list.append(elemLi);
          }
        });
      }
            
      rootContent();
      $("#home").click(rootContent);

    </script>
</body></html>