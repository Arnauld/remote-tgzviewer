<!doctype html>
<html>
<head>
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen">
  <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }

      @media (max-width: 980px) {
        /* Enable use of floated navbar text */
        .navbar-text.pull-right {
          float: none;
          padding-left: 5px;
          padding-right: 5px;
        }
      }
    </style>
</head>
<body lang="en">

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">tgz-Viewer</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a href="#" id="home">Home</a></li>
              <li><a href="#" id="archive"></a></li>
              <li><a href="#" id="file"></a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span12" id="list-container">
          <div class="well sidebar-nav">
            <ul id="list" class="nav nav-list"></ul>
          </div>
        </div>
      </div>
      <div class="row-fluid">
        <div class="span12" id="raw-container">
          <iframe id="raw" src="about:blank" width="800" height="10" frameborder="0" scrolling="yes"></iframe>
        </div>
      </div>
    </div>


    <script src="js/jquery-1.7.7.min.js"></script>
    <script src="js/sockjs-0.3.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>

    <script>
      function discardFrameContent() {
        $('#raw')
          .attr('height', 10)
          .attr('src', "about:blank");
      }

      function maximizeFrame () {
        var width = $('#raw-container').width();
        $('#raw')
          .attr('width', width)
          .attr('height', document.height - 160 - 5); // padding-top 100 + empty list 60 + approx 5
      }

      function loadArchiveContent() {
        var archive = $("#archive").text();
        var entry = $("#file").text();

        $('#list').empty();
        $('#raw')
          .attr('src', document.location.origin + "/entry-content?archive=" + archive + "&entry=" + entry);
          maximizeFrame ();
      }

      $(window).resize(function() {
        // iframe in use?
        var src = $('#raw').attr('src');
        if(src !== "about:blank") {
          maximizeFrame ();
        }
      });

      function entryClicked() {
        var text = $(this).text();
        $("#file").text(text);
        loadArchiveContent();
      }

      function listArchiveEntries() {
        var list = $('#list'),
            text = $("#archive").text();
        $.getJSON("/archive-entries?archive=" + text, function(res) {

          discardFrameContent();
          $("#file").text("");
          list.empty();
          
          console.log("Received: ", res);
          var n = res.length, i;
          for(i=0; i<n; i++) {
            console.log("appending ", res[i]);
            var elemA  = $("<a href='#'>" + res[i] + "</a>");
            elemA.click(entryClicked);
            var elemLi = $("<li class='entry'></li>");
            elemLi.append(elemA);
            list.append(elemLi);
          }
        });
      }

      function archiveClicked() {
        var text = $(this).text();
        $("#archive").text(text);
        $("#file").text("");
        listArchiveEntries();
      }

      function listArchives() {
        var list = $('#list');
        $.getJSON("/list-archives", function(res) {

          discardFrameContent();
          $("#archive").text("");
          $("#file").text("");
          list.empty()
          
          console.log("Received: ", res);
          var n = res.length, i;
          for(i=0; i<n; i++) {
            console.log("appending ", res[i]);
            var elemA  = $("<a href='#'>" + res[i] + "</a>");
            elemA.click(archiveClicked);
            var elemLi = $("<li class='archive'></li>");
            elemLi.append(elemA);
            list.append(elemLi);
          }
        });
      }
      $("#home").click(listArchives);
      $("#archive").click(listArchiveEntries);

      listArchives();
    </script>
</body></html>